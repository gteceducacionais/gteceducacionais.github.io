<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel de Administra√ß√£o</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #f1f5f9; }
    .tabs, .subtabs { display: flex; gap: 20px; padding: 0 24px; background-color: #f8fafc; }
    .tab, .subtab { padding: 12px 0; font-weight: 500; cursor: pointer; }
    .tab.active, .subtab.active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; }
    .content { padding: 24px; }
    .card { background-color: white; border-radius: 10px; padding: 20px; box-shadow: 0 0 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .header-bar {
      display: flex; justify-content: space-between; align-items: center;
      background-color: #2563eb; color: white; padding: 12px 24px; font-weight: bold;
    }
    .header-bar i { cursor: pointer; font-size: 18px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #ddd; text-align: left; padding: 8px; }
    th { background-color: #f1f5f9; }
    .btn { background-color: #16a34a; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; margin-top: 12px; }
    .delete { color: red; cursor: pointer; font-size: 18px; }
    .hidden { display: none; }
    .subtab-container { margin-top: 16px; }
  </style>
</head>
<body>
  <div class="header-bar">
    <i class="fa-solid fa-moon" title="Alternar tema"></i>
    <div>Sistema de Avalia√ß√£o | Feira Municipal de Itarema</div>
    <i class="fa-solid fa-right-from-bracket" title="Sair" onclick="logout()"></i>
  </div>

  <div class="tabs">
    <div class="tab active" data-aba="avaliadores">Gerenciar Avaliadores</div>
    <div class="tab" data-aba="projetos">Gerenciar Projetos</div>
    <div class="tab" data-aba="avaliacoes">Avalia√ß√µes Salvas</div>
  </div>

  <div class="content">
    <!-- Avaliadores -->
    <div class="card aba" id="aba-avaliadores">
      <h3>Avaliadores Cadastrados</h3>
      <table><thead><tr><th>Nome</th><th>Usu√°rio</th><th>A√ß√µes</th></tr></thead><tbody id="tabela-avaliadores"></tbody></table>
      <h4 style="margin-top: 24px;">Adicionar Novo Avaliador</h4>
      <div>
        <input type="text" id="nome" placeholder="Nome">
        <input type="text" id="usuario" placeholder="Usu√°rio">
        <input type="password" id="senha" placeholder="Senha">
        <button class="btn" id="btnAdicionarAvaliador">Adicionar Avaliador</button>
      </div>
    </div>

    <!-- Projetos -->
    <div class="card aba hidden" id="aba-projetos">
      <h3>Projetos Cadastrados</h3>
      <table><thead><tr><th>Projeto</th><th>Escola</th><th>N√≠vel</th><th>A√ß√µes</th></tr></thead><tbody id="tabela-projetos"></tbody></table>
      <h4 style="margin-top: 24px;">Novo Projeto</h4>
      <input type="text" id="tituloProjeto" placeholder="T√≠tulo">
      <input type="text" id="escolaProjeto" placeholder="Escola">
      <select id="nivelProjeto">
        <option value="N√≠vel I (3¬∫ ao 5¬∫ ano)">N√≠vel I</option>
        <option value="N√≠vel II (6¬∫ ao 9¬∫ ano)">N√≠vel II</option>
        <option value="N√≠vel III (EM)">N√≠vel III</option>
        <option value="N√≠vel IV (Cear√° Cient√≠fico)">N√≠vel IV</option>
      </select>
      <button class="btn" id="btnAdicionarProjeto">Adicionar Projeto</button>
    </div>

    <!-- Avalia√ß√µes -->
    <div class="aba hidden" id="aba-avaliacoes">
      <div class="subtabs">
        <div class="subtab active" data-subaba="individuais">Avalia√ß√µes Individuais</div>
        <div class="subtab" data-subaba="ranking">Ranking por N√≠vel</div>
      </div>

      <div class="subtab-container">
        <!-- Subaba: Individuais -->
        <div class="card subaba" id="subaba-individuais">
          <h3>Avalia√ß√µes Realizadas</h3>
          <table><thead><tr><th>Projeto</th><th>Avaliador</th><th>Nota</th><th>Coment√°rio</th><th>A√ß√µes</th></tr></thead><tbody id="tabela-avaliacoes"></tbody></table>
        </div>

        <!-- Subaba: Ranking -->
        <div class="card subaba hidden" id="subaba-ranking">
          <h3>Ranking por N√≠vel</h3>
          <div id="ranking-container">[Ranking ser√° gerado aqui]</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Alternar abas
      document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          document.querySelectorAll(".aba").forEach(a => a.classList.add("hidden"));
          tab.classList.add("active");
          const abaId = "aba-" + tab.getAttribute("data-aba");
          document.getElementById(abaId).classList.remove("hidden");
        });
      });

      // Alternar subabas
      document.querySelectorAll(".subtab").forEach(subtab => {
        subtab.addEventListener("click", () => {
          document.querySelectorAll(".subtab").forEach(s => s.classList.remove("active"));
          document.querySelectorAll(".subaba").forEach(sa => sa.classList.add("hidden"));
          subtab.classList.add("active");
          document.getElementById("subaba-" + subtab.getAttribute("data-subaba")).classList.remove("hidden");
        });
      });
    });
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAq3c957QKO6Ygq-f0NwDXWmuwZxkjNe1c",
      authDomain: "seducitarema-185aa.firebaseapp.com",
      projectId: "seducitarema-185aa",
      storageBucket: "seducitarema-185aa.appspot.com",
      messagingSenderId: "345071170470",
      appId: "1:345071170470:web:469ab81b881e91dd4a1567"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function gerarRanking(avaliacoes) {
      const rankingPorNivel = {};
      avaliacoes.forEach(av => {
        const nivel = av.nivel || "N√≠vel n√£o definido";
        if (!rankingPorNivel[nivel]) rankingPorNivel[nivel] = [];
        rankingPorNivel[nivel].push(av);
      });

      const container = document.getElementById("ranking-container");
      container.innerHTML = "";

      Object.entries(rankingPorNivel).forEach(([nivel, lista]) => {
        lista.sort((a, b) => (b.nota || 0) - (a.nota || 0));
        const bloco = document.createElement("div");
        bloco.style.marginBottom = "24px";

        const titulo = document.createElement("h4");
        titulo.textContent = nivel;
        titulo.style.color = "#1e3a8a";
        bloco.appendChild(titulo);

        const tabela = document.createElement("table");
        tabela.innerHTML = "<thead><tr><th>Posi√ß√£o</th><th>Projeto</th><th>Escola</th><th>Nota</th></tr></thead>";
        const tbody = document.createElement("tbody");

        lista.forEach((av, idx) => {
          const tr = document.createElement("tr");
          let medalha = idx === 0 ? "ü•á" : idx === 1 ? "ü•à" : idx === 2 ? "ü•â" : "";
          tr.innerHTML = `
            <td>${idx + 1} ${medalha}</td>
            <td>${av.projeto}</td>
            <td>${av.escola}</td>
            <td>${av.nota || 0}</td>`;
          tbody.appendChild(tr);
        });

        tabela.appendChild(tbody);
        bloco.appendChild(tabela);
        container.appendChild(bloco);
      });
    }

    function templateAvaliador(data, id) {
      return `<td>${data.nome}</td><td>${data.usuario}</td><td><span class="delete" data-id="${id}" data-tipo="avaliadores">üóëÔ∏è</span></td>`;
    }

    function templateAvaliacao(data, id) {
      return `<td>${data.projeto}</td><td>${data.nomeAvaliador || "-"}</td><td>${data.nota || 0}</td><td>${data.comentario || "-"}</td><td><span class="delete" data-id="${id}" data-tipo="avaliacoes">üóëÔ∏è</span></td>`;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await carregarColecao("avaliadores", "tabela-avaliadores", templateAvaliador);
      const snapshot = await getDocs(collection(db, "avaliacoes"));
      const avaliacoes = [];
      const tabela = document.getElementById("tabela-avaliacoes");
      tabela.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        avaliacoes.push(data);
        const tr = document.createElement("tr");
        tr.innerHTML = templateAvaliacao(data, docSnap.id);
        tabela.appendChild(tr);
      });
      gerarRanking(avaliacoes);

      document.body.addEventListener("click", async (e) => {
        if (e.target.classList.contains("delete")) {
          const id = e.target.dataset.id;
          const tipo = e.target.dataset.tipo;
          if (confirm("Deseja remover este item?")) {
            await deleteDoc(doc(db, tipo, id));
            location.reload(); // simples recarregamento por seguran√ßa
          }
        }
      });
    });

    async function carregarColecao(nome, tabelaId, colunas) {
      const tabela = document.getElementById(tabelaId);
      tabela.innerHTML = "";
      const snapshot = await getDocs(collection(db, nome));
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = colunas(data, docSnap.id);
        tabela.appendChild(tr);
      });
    }
  </script>
</body>
</html>
